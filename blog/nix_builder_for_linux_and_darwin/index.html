<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Setup a nix-builder for linux and darwin (with Tailscale) [Draft] | Bastien Rivière</title><meta name=description content="Hi! I am Bastien, a developper and an ops/sre. This is my blog where I throw all my random stuff that I want to keep for later."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Setup a nix-builder for linux and darwin (with Tailscale) [Draft]"><meta property="og:description" content="A journey to install NixOS Today, I want to install NixOS on my old laptop. His goal is to be a multi-arch builder. That means it will support these architectures:
 x86_64-linux (native) x86_64-darwin (qemu) and more arch via cross-compilation (if possible)  Why I am doing this? Currently, I have a macbook pro from my current job. Docker on Mac is, to be honest, a nightmare in term of performance, and since we are developping a big application (in Elixir), it requires a beefy machine."><meta property="og:type" content="article"><meta property="og:url" content="https://babariviere.com/blog/nix_builder_for_linux_and_darwin/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-06-28T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-28T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup a nix-builder for linux and darwin (with Tailscale) [Draft]"><meta name=twitter:description content="A journey to install NixOS Today, I want to install NixOS on my old laptop. His goal is to be a multi-arch builder. That means it will support these architectures:
 x86_64-linux (native) x86_64-darwin (qemu) and more arch via cross-compilation (if possible)  Why I am doing this? Currently, I have a macbook pro from my current job. Docker on Mac is, to be honest, a nightmare in term of performance, and since we are developping a big application (in Elixir), it requires a beefy machine."><link rel=stylesheet href=https://babariviere.com/css/style-dark.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://babariviere.com/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://babariviere.com/><div id=logo style=background-image:url(https://babariviere.com/images/logo.png)></div><div id=title><h1>Bastien Rivière</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/blog>Blog</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=content itemprop=articleBody><h2 id=a-journey-to-install-nixos>A journey to install NixOS</h2><p>Today, I want to install NixOS on my old laptop. His goal is to be a multi-arch builder. That means it will support these architectures:</p><ul><li>x86_64-linux (native)</li><li>x86_64-darwin (qemu)</li><li>and more arch via cross-compilation (if possible)</li></ul><p>Why I am doing this? Currently, I have a macbook pro from my current job.
Docker on Mac is, to be honest, a nightmare in term of performance, and since we are developping a big application (in Elixir),
it requires a beefy machine.</p><h3 id=plan>Plan</h3><p>First, we will setup NixOS as we always do:</p><ul><li>download NixOS iso</li><li>flash it on an USB device</li><li>boot it on your machine</li><li>partition disk</li><li>generate NixOS config</li><li>setup wifi (my laptop doesn&rsquo;t have an ethernet port)</li></ul><p>Then, we will write a small configuration setup on my working machine. Since I am using Nix flake, the configuration will be available
in my github repository.</p><p>We want these services to be enabled:</p><ul><li>docker (I don&rsquo;t want to run it on my mac anymore)</li><li>prometheus and grafana (for those nice graphs)</li><li>nix-serve (to serve binary cache)</li><li>and maybe more&mldr;</li></ul><p>And for the final step, and the most painful one, find a way to:</p><ul><li>create a OSX instance via qemu</li><li>find a way to make it replicable with NixOS/NixOps</li></ul><h3 id=installing-nixos>Installing NixOS</h3><p>Let&rsquo;s start by downloading the iso from <a href=https://nixos.org/download.html>NixOS Download Page</a>. Personally, I always take the minimal ISO image since I don&rsquo;t need graphical
interface (and there is no graphical installer, so I guess it&rsquo;s only for testing purpose?).</p><p>Now, we can flash that iso into a USB drive. It&rsquo;s easy as that:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>~/Downloads/nixos-minimal-...-x86_64-linux.iso of<span style=color:#f92672>=</span>/dev/sdx
sync <span style=color:#75715e># ensure that everything is written on the disk</span>
</code></pre></div><p>Replace <code>/dev/sdx</code> with the correct device on your system. If you don&rsquo;t know how to find it, you can run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># On Linux</span>
lsblk -b
<span style=color:#75715e># On MacOS</span>
diskutil list
</code></pre></div><p>Everything is explained here from the official documentation: <a href=https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb>https://nixos.org/manual/nixos/stable/index.html#sec-booting-from-usb</a></p><p>Now that our USB device is ready, let&rsquo;s boot it!</p><p>First thing: we need to setup the network. If you have an ethernet cable, you will probably have an internet connection, otherwise, setup internet via `wpa_supplicant` (you should look <a href=https://nixos.org/manual/nixos/stable/index.html#sec-installation-booting-networking>here</a>).</p><p>After that, we are setting up our partitions.
I usually do this partitioning:</p><table><thead><tr><th>partition</th><th>size</th><th>fs type</th></tr></thead><tbody><tr><td>/boot</td><td>1GB</td><td>fat32</td></tr><tr><td></td><td>&lt;ram size / 2></td><td>swap</td></tr></tbody></table><p>Since I am using ZFS, I use this documentation as an helper: <a href=https://nixos.wiki/wiki/NixOS%5Fon%5FZFS>https://nixos.wiki/wiki/NixOS%5Fon%5FZFS</a></p><p>For my ZFS pool setup, I have this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ zpool create -O mountpoint<span style=color:#f92672>=</span>none -f tank /dev/nvme1n1p3 /dev/nvme0n1p1
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy tank/system
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy tank/system/var
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy tank/local
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy -o compression<span style=color:#f92672>=</span>on -o atime<span style=color:#f92672>=</span>off tank/local/nix
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy tank/user
$ zfs create -o mountpoint<span style=color:#f92672>=</span>legacy tank/user/home
$ zfs set xattr<span style=color:#f92672>=</span>sa acltype<span style=color:#f92672>=</span>posixacl tank/system/var

$ zfs list
NAME              USED  AVAIL     REFER  MOUNTPOINT
tank              438K   651G       24K  none
tank/local         48K   651G       24K  legacy
tank/local/nix     24K   651G       24K  legacy
tank/system        48K   651G       24K  legacy
tank/system/var    24K   651G       24K  legacy
tank/user          48K   651G       24K  legacy
tank/user/home     24K   651G       24K  legacy
</code></pre></div><p>You probably want to read this for best partitions: <a href=https://grahamc.com/blog/nixos-on-zfs>https://grahamc.com/blog/nixos-on-zfs</a></p><p>So, my partition is correctly setup, I can now mount everything and generate my config:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ mount -t zfs tank/system /mnt
$ mkdir -p /mnt/<span style=color:#f92672>{</span>home,var,nix<span style=color:#f92672>}</span>
$ mount -t zfs tank/local/nix /mnt/nix
$ mount -t zfs tank/system/var /mnt/var
$ mount -t zfs tank/user/home /mnt/home
$ nixos-generate-config --root /mnt
</code></pre></div><p>After modifying the configuration, and ensuring that the configuration file contains:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>  boot<span style=color:#f92672>.</span>initrd<span style=color:#f92672>.</span>supportedFilesystems <span style=color:#960050;background-color:#1e0010>=</span> [ <span style=color:#e6db74>&#34;zfs&#34;</span> ];
  boot<span style=color:#f92672>.</span>supportedFilesystems <span style=color:#960050;background-color:#1e0010>=</span> [ <span style=color:#e6db74>&#34;zfs&#34;</span> ];
  networking<span style=color:#f92672>.</span>hostId <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#e6db74>&#34;&lt;head -c 8 /etc/machine-id&gt;&#34;</span>;
  networking<span style=color:#f92672>.</span>wireless<span style=color:#f92672>.</span>enable <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># if you don&#39;t have ethernet</span>
  networking<span style=color:#f92672>.</span>wireless<span style=color:#f92672>.</span>interfaces <span style=color:#960050;background-color:#1e0010>=</span> [<span style=color:#e6db74>&#34;&lt;interface&gt;&#34;</span>];
</code></pre></div><p>If you are on laptop, add this to your configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>services<span style=color:#f92672>.</span>logind<span style=color:#f92672>.</span>lidSwitch <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#e6db74>&#34;ignore&#34;</span>;
</code></pre></div><p>It will disable the &ldquo;sleep on lid close&rdquo;.</p><p>And finally:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ nixos-install
</code></pre></div><p>Yeah! NixOS is now installed!</p><p>It&rsquo;s not time for reboot.</p><h3 id=configuring-our-machine>Configuring our machine</h3><h4 id=setup-tailscale-and-ssh>Setup Tailscale and SSH</h4><p>Let&rsquo;s by enabling OpenSSH so we can access remotely our machine.</p><p>To do this, start by adding this in your configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>services<span style=color:#f92672>.</span>openssh<span style=color:#f92672>.</span>enable <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>;
</code></pre></div><p>Now, connect to your machine and copy your public ssh key so you don&rsquo;t have to enter the password again.</p><p>Next, we can setup tailscale. It is as simple as this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>services<span style=color:#f92672>.</span>tailscale<span style=color:#f92672>.</span>enable <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>;
networking<span style=color:#f92672>.</span>firewall <span style=color:#960050;background-color:#1e0010>=</span> {
  allowedUDPPorts <span style=color:#f92672>=</span> [ config<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>tailscale<span style=color:#f92672>.</span>port ];
  <span style=color:#75715e># required if you want to SSH to the machine, for example</span>
  trustedInterfaces <span style=color:#f92672>=</span> [ config<span style=color:#f92672>.</span>services<span style=color:#f92672>.</span>tailscale<span style=color:#f92672>.</span>interfaceName ];
};
</code></pre></div><p>Activate both services with:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>nixos-rebuild switch
</code></pre></div><p>Go to tailscale admin console, and generate a temporary key (one-time usage).
It will be used to connect to tailscale without the user interface.</p><p>Once you have your key, run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>tailscale up --authkey tskey-...
</code></pre></div><p>And now your machine is connected to the private network!</p><p>Since you can access it from tailscale, let&rsquo;s make the SSH port private (by excluding it from the firewall).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>services<span style=color:#f92672>.</span>openssh<span style=color:#f92672>.</span>openFirewall <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>false</span>;
</code></pre></div><p>Don&rsquo;t forget to <code>nixos-rebuild switch</code>!</p><p>You can check that it&rsquo;s now inaccessible by running your usual ssh command. It should get stuck and you will have a timeout.
To access it, you have to use the private IP from tailscale.</p><h4 id=enable-nix-serve>Enable nix-serve</h4></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2021 Bastien Rivière</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/blog>Blog</a></li><li><a href=/tags>Tags</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>